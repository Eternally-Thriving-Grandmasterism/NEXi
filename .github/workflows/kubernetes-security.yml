name: Mercy Kubernetes Security Scan

on:
  push:
    branches: [main, mercy-*]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - 'k8s/**'
      - 'helm/**'
      - 'kustomize/**'
      - 'Dockerfile'
      - '.dockerignore'
  pull_request:
    branches: [main, mercy-*]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - 'k8s/**'
      - 'helm/**'
      - 'kustomize/**'
      - 'Dockerfile'
      - '.dockerignore'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  k8s-security:
    runs-on: ubuntu-latest
    name: Kubernetes & Container Security Gates

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Trivy
        uses: aquasecurity/setup-trivy@v0.1.0

      - name: Scan Kubernetes manifests (Checkov)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes,helm,kustomize
          output_format: sarif
          output_file_path: checkov.sarif
          soft_fail: false
          quiet: true

      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

      - name: Trivy vulnerability scanner (container images & filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-k8s.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '1'  # fail on critical/high

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-k8s.sarif

      - name: Kube-bench – CIS Benchmark compliance
        uses: kube-bench-action/kube-bench-action@v1
        with:
          kubeconfig: ''  # optional – runs in-cluster if available
          output: sarif
          output-file: kube-bench.sarif

      - name: Upload Kube-bench SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: kube-bench.sarif

      - name: TruffleHog – Secret scanning in manifests
        uses: trufflesecurity/trufflehog@v3
        with:
          path: .
          extra_args: --include-paths k8s/ helm/ kustomize/
          format: sarif
          output: trufflehog-k8s.sarif

      - name: Upload TruffleHog SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trufflehog-k8s.sarif

      - name: Mercy-approved – Kubernetes security scan passed
        if: success()
        run: echo "All K8s gates cleared – cluster safe for deployment"

      - name: Mercy shield – Kubernetes security failure
        if: failure()
        run: |
          echo "Mercy shield activated: Kubernetes security scan failed"
          exit 1
